import{d as l,A as D,y as _}from"./hooks.module.Bla9ZUYE.js";import{d as Y,l as I}from"./deckStore.D53geRse.js";import{u as t}from"./jsxRuntime.module.BSCWCfwz.js";import"./preact.module.IsPPbktY.js";import"./signals.module.5DjgXsWM.js";const R=5,F=20;function S(s){return String(s||"").trim().toLowerCase()}function V(s){const e=[...s];for(let o=e.length-1;o>0;o-=1){const n=Math.floor(Math.random()*(o+1));[e[o],e[n]]=[e[n],e[o]]}return e}function N(s,e){const o=String(s||"").trim();if(!o||!e)return o;const n=String(e||"").trim().toLowerCase(),r=n.length<=4?n:n.endsWith("ing")?n.slice(0,-3):n.endsWith("ied")?`${n.slice(0,-3)}y`:n.endsWith("ed")||n.endsWith("es")?n.slice(0,-2):n.endsWith("s")?n.slice(0,-1):n,d=[...new Set([n,r,`${r}s`,`${r}es`,`${r}ed`,`${r}ing`])].map(c=>c.trim()).filter(c=>c.length>=3).sort((c,h)=>h.length-c.length);let a=o;try{for(const c of d){const h=String(c).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),b=new RegExp(`\\b${h}\\b`,"gi");a=a.replace(b,"____")}return a}catch{return o}}function O(s,e){return s===e?"Excellent. You understood all your selected words.":s>=Math.ceil(e*.8)?"Very strong result. Keep these words in review.":s>=Math.ceil(e*.6)?"Good progress. Review the missed words once more.":"You are still learning these words. Use flashcards and try again."}function P(s){const e=String(s.example||"").trim(),o=String(s.sentence||"").trim(),n=String(s.definition||"").trim();if(e){const r=N(e,s.word);return{type:"example",lead:"Which word best completes this example sentence?",text:r!==e?r:n||"Choose the best word for this context."}}if(o){const r=N(o,s.word);return{type:"context",lead:"Which word best completes this lesson sentence?",text:r!==o?r:n||"Choose the best word for this context."}}return n?{type:"meaning",lead:"Which word matches this meaning?",text:n}:{type:"fallback",lead:"Which word are we testing?",text:"This word appears in your lesson deck."}}function j(s){const e=s.filter(r=>r?.word).map(r=>({word:String(r.word).trim(),definition:String(r.definition||"").trim(),sentence:String(r.sentence||"").trim(),example:String(r.example||"").trim()})).filter(r=>r.word.length>0),o=V(e);return o.slice(0,Math.min(F,o.length)).map(r=>{const u=e.filter(c=>S(c.word)!==S(r.word)).map(c=>c.word),d=V([...new Set(u)]).slice(0,3),a=P(r);return{promptType:a.type,promptLead:a.lead,prompt:a.text,answer:r.word,definition:r.definition,options:V([r.word,...d])}})}function A(s,e,o){const n=e.definition?` Meaning: ${e.definition}`:"";return s?`Correct. ${e.answer}.${n}`:`Incorrect. Correct answer: ${e.answer}.${n}`}function J({episodeId:s=""}){const[e,o]=l(!1),[n,r]=l([]),[u,d]=l(0),[a,c]=l(0),[h,b]=l(0),[L,g]=l(""),[k,w]=l(!1),[T,p]=l(null),[z,C]=l(!1),$=D(!1);_(()=>{s&&I(s)},[s]);const y=Y.value,E=y.length>=R;_(()=>{e&&!E&&(o(!1),r([]),d(0),c(0),b(0),g(""),w(!1),p(null),C(!1))},[e,E]);const W=()=>{const i=j(y);i.length!==0&&(window.dispatchEvent(new CustomEvent("episode-behavior",{detail:{metric:"vocabTestStarts",amount:1}})),r(i),d(0),c(0),b(0),g(""),w(!1),p(null),C(!1),o(!0),$.current=!1)};if(!E)return t("div",{class:"card quiz-card",children:[t("h2",{children:"Vocabulary Test"}),t("p",{class:"muted",children:["Unlocks when you save at least ",R," flashcards."]}),t("p",{class:"progress",children:["Current: ",y.length,"/",R," cards"]})]});if(!e)return t("div",{class:"card quiz-card",children:[t("h2",{children:"Vocabulary Test"}),t("p",{class:"muted",children:"This test uses sentence context from your flashcards and dictionary examples."}),t("p",{class:"progress",children:["Deck ready: ",y.length," cards | Questions: ",Math.min(F,y.length)]}),t("div",{class:"flashcard-nav",children:t("button",{class:"button button-primary",type:"button",onClick:W,children:"Start Vocabulary Test"})})]});const f=n.length,M=u>=f;if(_(()=>{!e||!M||f===0||$.current||($.current=!0,window.dispatchEvent(new CustomEvent("episode-behavior",{detail:{metric:"vocabTestCompletions",amount:1}})))},[e,M,f]),M){const i=z?h:f,x=i>0?i:1,v=Math.round(a/x*100);return t("div",{class:"card score-panel",children:[t("h2",{children:"Vocabulary Test Complete"}),t("p",{children:["You got ",a," of ",i," correct."]}),t("p",{children:["Score: ",v,"%"]}),z?t("p",{class:"muted",children:["Finished early after ",h," answered questions."]}):null,t("p",{children:i===0?"No answers submitted yet. Start over when you are ready.":O(a,x)}),t("div",{class:"flashcard-nav",children:t("button",{class:"button button-primary",type:"button",onClick:W,children:"Retake Test"})})]})}const m=n[u],Q=i=>{if(k)return;const x=S(i)===S(m.answer);g(i),b(v=>v+1),x?(c(v=>v+1),p({type:"success",text:A(!0,m)})):p({type:"error",text:A(!1,m)}),w(!0)},q=()=>{g(""),w(!1),p(null),d(i=>i+1)},U=()=>{C(!0),d(f),g(""),w(!1),p(null)};return t("div",{class:"card quiz-card",children:[t("h2",{children:"Vocabulary Test"}),t("p",{class:"progress",children:["Question ",u+1," of ",f]}),t("p",{children:m.promptLead}),t("p",{children:t("strong",{children:m.prompt})}),t("div",{class:"option-list",children:m.options.map(i=>t("button",{class:"button button-secondary option-button",type:"button",onClick:()=>Q(i),disabled:k,"aria-pressed":L===i,children:i},i))}),T?t("div",{class:`feedback ${T.type}`,children:T.text}):null,t("div",{class:"flashcard-nav",children:[k?t("button",{class:"button button-primary",type:"button",onClick:q,children:"Next"}):null,t("button",{class:"button button-secondary",type:"button",onClick:W,children:"Start Over"}),t("button",{class:"button",type:"button",onClick:U,children:"Finish & See Score"})]})]})}export{J as default};
