import{d as E,q as ae,y as O}from"./hooks.module.Bla9ZUYE.js";import{d as re,e as se,l as ce,f as le}from"./deckStore.D53geRse.js";import{a as de,l as ue}from"./assistLanguage.BopRrTWD.js";import{u as d}from"./jsxRuntime.module.BSCWCfwz.js";import"./preact.module.IsPPbktY.js";import"./signals.module.5DjgXsWM.js";const A=new Map,pe=[[/\bthe act of\b/gi,"doing"],[/\bthe process of\b/gi,"the way of"],[/\bused to\b/gi,"used for"],[/\bobtain\b/gi,"get"],[/\butilize\b/gi,"use"],[/\breside\b/gi,"live"],[/\bconsume\b/gi,"eat or drink"],[/\bcommence\b/gi,"start"],[/\bterminate\b/gi,"end"],[/\bapproximately\b/gi,"about"],[/\bin order to\b/gi,"to"],[/\bthat is to say\b/gi,"meaning"],[/\be\.g\.\b/gi,"for example"],[/\bi\.e\.\b/gi,"in other words"]],fe=[/\bdrug\b/i,/\bnarcotic\b/i,/\bobsolete\b/i,/\barchaic\b/i,/\bslang\b/i,/\bbiology\b/i,/\banatomy\b/i,/\bepithet\b/i,/\babusive\b/i,/\binsult(?:ing)?\b/i,/\bpejorative\b/i,/\boffensive\b/i];function I(n){return String(n||"").replace(/\s+/g," ").trim()}function me(n){return n?n.charAt(0).toUpperCase()+n.slice(1):""}function H(n){const t=I(n).toLowerCase(),e=t.split(/\s+/).filter(Boolean),i=e.filter(r=>r.replace(/[^a-z]/g,"").length>=11).length,o=/[;:()]/.test(t)?2:0;return e.length+i*2+o}function be(n){const t=[];for(const s of n.meanings||[])for(const c of s.definitions||[]){const u=I(c?.definition);u&&t.push({definition:u,partOfSpeech:s?.partOfSpeech||"",example:I(c?.example||"")})}if(!t.length)return{definition:"",partOfSpeech:"",example:""};const e=t.filter(s=>{const c=s.definition.split(/\s+/).filter(Boolean).length;return c>=5&&c<=24}),i=e.length?e:t,o=i.filter(s=>!fe.some(c=>c.test(s.definition))),r=o.length?o:i;return r.sort((s,c)=>H(s.definition)-H(c.definition)),r[0]}function ge(n){let t=I(n);if(!t)return"";t=t.replace(/\([^)]*\)/g,""),t=t.replace(/\[[^\]]*\]/g,""),t=I(t);for(const[i,o]of pe)t=t.replace(i,o);t=t.replace(/\bchiefly\b/gi,"mostly").replace(/\busually\b/gi,"often").replace(/\bone who\b/gi,"a person who").replace(/\bthat which\b/gi,"something that"),t=I(t.replace(/\s+,/g,",").replace(/\s+\./g,"."));const e=t.split(/\s+/).filter(Boolean);if(e.length>20){const i=t.split(/[;:]/)[0];t=i.split(/\s+/).filter(Boolean).length>=5?i:`${e.slice(0,20).join(" ")}...`}return me(t)}async function he(n){const t=n.toLowerCase().trim();if(!t||t.length<2)return null;if(A.has(t))return A.get(t);try{const e=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(t)}`);if(!e.ok)return A.set(t,null),null;const o=(await e.json())[0];if(!o)return A.set(t,null),null;const r=o.phonetic||o.phonetics?.find(k=>k.text)?.text||"",s=be(o),c=s.definition||"";let u=ge(c);u||(u=c);const m={word:o.word||t,phonetic:r,partOfSpeech:s.partOfSpeech||"",definition:u,rawDefinition:c,example:s.example||""};return A.set(t,m),m}catch{return A.set(t,null),null}}const P=new Map;function j(n){return String(n||"").replace(/\s+/g," ").trim()}function we(n,t){return`${t}:${j(n).toLowerCase()}`}async function ye(n,t="ja"){const e=j(n),i=String(t||"").toLowerCase();if(!e||!["ja","es"].includes(i))return"";const o=we(e,i);if(P.has(o))return P.get(o);try{const r=new URL("https://api.mymemory.translated.net/get");r.searchParams.set("q",e.slice(0,280)),r.searchParams.set("langpair",`en|${i}`);const s=await fetch(r.toString());if(!s.ok)return P.set(o,""),"";const c=await s.json(),u=j(c?.responseData?.translatedText||"");return!u||u.toLowerCase()===e.toLowerCase()?(P.set(o,""),""):(P.set(o,u),u)}catch{return P.set(o,""),""}}const x=new Map;function h(n){return String(n||"").replace(/\s+/g," ").trim()}function W(n,t=120){const e=h(n).replace(/[;:]/g,". ");if(!e)return"";const i=e.split(/[.!?]/).map(o=>h(o)).find(Boolean)||e;return i.length<=t?i:`${i.slice(0,t-1).trim()}...`}function ve(n,t,e){return`${h(n).toLowerCase()}|${h(t).toLowerCase()}|${h(e).toLowerCase()}`}function xe(){if(typeof window>"u")return"";const n=h(window.__OVI_CONTEXT_API_BASE_URL||"");if(n)return n.replace(/\/$/,"");try{const t=h(localStorage.getItem("ovi-context-api-base-url"));if(t)return t.replace(/\/$/,"")}catch{}return"https://api.ovienglish.com"}function Se(){if(typeof window>"u")return"";const n=h(window.__OVI_CONTEXT_API_KEY||"");if(n)return n;try{const t=h(localStorage.getItem("ovi-context-api-key"));if(t)return t}catch{}return""}async function Me({word:n,sentence:t,definition:e}){const i=h(n),o=h(t),r=h(e);if(!i||!o)return null;const s=ve(i,o,r);if(x.has(s))return x.get(s);const c=xe();if(!c)return x.set(s,null),null;try{const u={"Content-Type":"application/json"},m=Se();m&&(u["x-api-key"]=m);const k=await fetch(`${c}/api/context-explain`,{method:"POST",headers:u,body:JSON.stringify({word:i,sentence:o,definition:r})});if(!k.ok)return x.set(s,null),null;const w=await k.json();if(!w?.success||!w?.data)return x.set(s,null),null;const R=W(w.data.simpleMeaning||"",110),S=W(w.data.contextMeaning||"",120),M=W(w.data.example||"",120);if(!R&&!S)return x.set(s,null),null;const N={simpleMeaning:R,contextMeaning:S,example:M};return x.set(s,N),N}catch{return x.set(s,null),null}}function a(n){return String(n||"").replace(/\s+/g," ").trim()}function Le(n,t,e){return Math.max(t,Math.min(e,n))}function Y(n){const t=a(n);return t?t.charAt(0).toLowerCase()+t.slice(1):""}function Ee(n){return a(n).replace(/[.!?]+$/g,"")}function ke(n){return String(n||"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const $e=[[/\butilize\b/gi,"use"],[/\bobtain\b/gi,"get"],[/\bapproximately\b/gi,"about"],[/\bcommence\b/gi,"start"],[/\bterminate\b/gi,"end"],[/\breside\b/gi,"live"],[/\bexpedient\b/gi,"convenient"],[/\bconcept\b/gi,"idea"],[/\bindividual\b/gi,"person"],[/\bnotion\b/gi,"idea"]];function g(n,t=120){let e=a(n);if(!e)return"";e=e.replace(/\([^)]*\)/g,""),e=e.replace(/\[[^\]]*\]/g,""),e=e.replace(/[;:]/g,". ");for(const[o,r]of $e)e=e.replace(o,r);e=a(e);const i=e.split(/[.!?]/).map(o=>a(o)).find(Boolean)||e;return i.length<=t?i:`${i.slice(0,t-1).trim()}...`}function T(n,t=160){const e=a(n);return e?e.length<=t?e:`${e.slice(0,t-1).trim()}...`:""}function U(n,t,e){const i=a(n),o=a(t),r=Y(e);return r?`In this sentence, "${i}" means ${r}.`:o?`"${i}" is a key word in this sentence.`:""}function B(n,t){const e=a(n),i=Ee(g(t,96));if(!e&&i)return i;if(!e)return"No simple meaning found yet.";if(!i)return`A ${e} is a word used in this lesson.`;const o=/^[aeiou]/i.test(e)?"An":"A",r=i.replace(new RegExp(`^${ke(e)}\\s+(is|means)\\s+`,"i"),"");return`${o} ${e} is ${Y(r)}.`}function z(n,t){const e=a(n),i=a(t);return i||(e?`I can use "${e}" when I talk about this topic.`:"")}function Ce(n){if(typeof window>"u")return null;const t=Number(n?.anchorX),e=Number(n?.anchorY);if(!Number.isFinite(t)||!Number.isFinite(e))return null;const i=window.innerWidth||390,o=window.innerHeight||844;if(i<=768)return null;const r=12,s=Math.max(280,Math.min(460,i-r*2)),c=320,u=Le(t-s/2,r,Math.max(r,i-s-r));let m=e+10;return m+c>o-r&&(m=Math.max(r,e-c-14)),{left:`${Math.round(u)}px`,top:`${Math.round(m)}px`,width:`${Math.round(s)}px`}}function Re(){const[n,t]=E(null),[e,i]=E(null),[o,r]=E(!1),[s,c]=E(!1),[u,m]=E(!1),[k,w]=E(!1),[R,S]=E({word:""}),M=de.value,N=re.value.length,$=ae(()=>{t(null),i(null),r(!1),c(!1),m(!1),w(!1),S({word:""}),window.speechSynthesis?.cancel?.(),window.dispatchEvent(new CustomEvent("vocab-popup-closed"))},[]);if(O(()=>{ue();const l=document.querySelector("[data-episode-id]"),y=String(l?.getAttribute("data-episode-id")||"").trim();y&&ce(y)},[]),O(()=>{window.__vocabPopupReady=!0;let l=window.scrollY;const y=L=>{const f=L?.detail||{},D=a(f.word);if(!D)return;const _={word:D,sentence:a(f.sentence),definition:a(f.definition),example:a(f.example),contextMeaning:a(f.contextMeaning),simpleMeaning:a(f.simpleMeaning),contextWhy:a(f.contextWhy),simpleParaphrase:a(f.simpleParaphrase),anchorX:Number(f.anchorX),anchorY:Number(f.anchorY)};l=window.scrollY,t(_),i(_),r(!0),c(!1),m(!1),window.speechSynthesis?.cancel?.()},b=L=>{L.key==="Escape"&&$()},p=()=>$(),v=()=>{Math.abs(window.scrollY-l)>160&&$()},C=L=>{const f=L.target;f instanceof Element&&(f.closest(".vocab-bottom-sheet")||f.closest("[data-word]")||$())};return window.addEventListener("open-vocab-popup",y),window.addEventListener("keydown",b),window.addEventListener("close-vocab-popup",p),window.addEventListener("scroll",v,{passive:!0}),window.addEventListener("pointerdown",C),()=>{window.__vocabPopupReady=!1,window.removeEventListener("open-vocab-popup",y),window.removeEventListener("keydown",b),window.removeEventListener("close-vocab-popup",p),window.removeEventListener("scroll",v),window.removeEventListener("pointerdown",C),window.speechSynthesis?.cancel?.()}},[$]),O(()=>{let l=!1;return n?((async()=>{try{let b=a(n.definition),p=a(n.example),v=null;if(!b||!p){if(v=await he(n.word),l)return;b||(b=a(v?.definition||v?.rawDefinition||"")),p||(p=a(v?.example||""))}const C=await Me({word:n.word,sentence:n.sentence,definition:b||a(n.simpleMeaning)});if(l)return;const L=a(C?.simpleMeaning),f=a(C?.contextMeaning),D=a(C?.example),_=g(L||a(n.simpleMeaning)||B(n.word,b),98)||"No simple meaning found yet",ie=g(f||a(n.contextMeaning)||U(n.word,n.sentence,b||_),112),oe=g(D||p||a(v?.example)||z(n.word,n.sentence),112);i({...n,definition:g(b,96)||_,simpleMeaning:_,contextMeaning:ie,example:oe,contextWhy:"",simpleParaphrase:""})}catch{if(l)return;const p=g(a(n.simpleMeaning)||B(n.word,n.definition),98)||"No simple meaning found yet";i({...n,definition:g(n.definition,96)||p,simpleMeaning:p,contextMeaning:g(a(n.contextMeaning)||U(n.word,n.sentence,p),112),example:g(n.example||z(n.word,n.sentence),112)})}finally{l||r(!1)}})(),()=>{l=!0}):()=>{l=!0}},[n]),O(()=>{let l=!1;return!e||M==="en"?(S({word:""}),w(!1),()=>{l=!0}):(w(!0),Promise.all([ye(e.word,M)]).then(([y])=>{l||S({word:a(y)})}).catch(()=>{l||S({word:""})}).finally(()=>{l||w(!1)}),()=>{l=!0})},[e?.word,M]),!e)return null;const K=se(e.word),X=N>=20,V=M==="ja"?"Japanese":"Spanish",F=Ce(e),q=!!F,G=T(g(e.contextMeaning||"",112),112),J=T(g(e.simpleMeaning||B(e.word,e.definition),98),98),Q=T(g(e.sentence,120),122),Z=T(g(e.example||e.sentence,110),112),ee=T(R.word,70),ne=()=>{le({word:e.word,sentence:e.sentence,definition:e.simpleMeaning||e.definition,contextMeaning:e.contextMeaning,sourceSentence:e.sentence,phonetic:"",partOfSpeech:"",example:e.example})&&(c(!0),window.dispatchEvent(new CustomEvent("episode-behavior",{detail:{metric:"flashcardAdds",amount:1}})),window.setTimeout(()=>c(!1),1300))},te=(l,y)=>{y?.stopPropagation?.();const b=a(l);if(!b||!window.speechSynthesis)return;m(!0),window.speechSynthesis.cancel();const p=new SpeechSynthesisUtterance(b);p.rate=.85,p.lang="en-US",p.onend=()=>m(!1),p.onerror=()=>m(!1),window.speechSynthesis.speak(p)};return d("div",{class:`vocab-bottom-sheet ${q?"is-anchored":"is-bottom"}`,style:F||void 0,role:"complementary","aria-label":`Definition for ${e.word}`,children:[d("div",{class:"vocab-sheet-handle"}),d("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[d("h3",{style:{margin:0},children:e.word}),d("button",{class:`voice-btn ${u?"is-speaking":""}`,type:"button",onClick:l=>te(e.word,l),"aria-label":`Listen to ${e.word}`,title:"Listen",children:"ðŸ”Š"})]}),d("p",{class:"vocab-mini-line vocab-line-card vocab-line-meaning",children:[d("strong",{children:"Simple Meaning:"})," ",o?"Loading simple meaning...":J]}),d("p",{class:"vocab-mini-line vocab-line-card vocab-line-context-sentence",children:[d("strong",{children:"Context sentence:"})," ",Q||"No context sentence available."]}),d("p",{class:"vocab-mini-line vocab-line-card vocab-line-context",children:[d("strong",{children:"In this sentence:"})," ",o?"Loading context...":G||"No context meaning available yet."]}),d("p",{class:"vocab-mini-line muted vocab-line-card vocab-line-example",children:[d("strong",{children:"Example:"})," ",o?"Loading example...":Z||"No example available."]}),M!=="en"?d("p",{class:"vocab-mini-line muted",children:[d("strong",{children:["Translation (",V,"):"]})," ",k?"Translating...":ee||"Translation unavailable"]}):null,d("div",{class:"vocab-popup-actions",children:[s?d("button",{class:"button button-secondary",type:"button",disabled:!0,style:{background:"#dcfce7",borderColor:"#16a34a",color:"#16a34a"},children:"Added!"}):K?d("button",{class:"button button-secondary",type:"button",disabled:!0,style:{opacity:.6},children:"In your deck"}):X?d("button",{class:"button button-secondary",type:"button",disabled:!0,style:{opacity:.55},children:"Deck full (20/20)"}):d("button",{class:"button button-primary",type:"button",onClick:ne,children:["+ Add to Flashcards (",N,"/20)"]}),d("button",{class:"button button-secondary button-close",type:"button",onClick:$,children:"Close"})]})]})}export{Re as default};
