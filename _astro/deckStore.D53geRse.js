import{signal as I}from"./signals.module.5DjgXsWM.js";function b(e){return e==="again"?.35:e==="hard"?.8:e==="easy"?1.8:1.25}function N(e,n){const t=Math.max(e||8,1),s=Math.round(t*b(n));return Math.min(Math.max(s,1),1080)}function E(e,n,t){const s=new Date(e||Date.now()),r=N(n,t);return new Date(s.getTime()+r*60*60*1e3).toISOString()}function z(e){return e.nextReviewAt?new Date(e.nextReviewAt)<=new Date:!0}const g="ovi-deck-",y="ovi-learned-words-v1",G=20,u=I([]),d=I([]);let v=null;function f(e){return String(e||"").replace(/\s+/g," ").trim().toLowerCase()}function l(e){return String(e||"").replace(/\s+/g," ").trim()}function S(e){return{word:l(e?.word),sentence:l(e?.sentence),definition:l(e?.definition),phonetic:l(e?.phonetic),partOfSpeech:l(e?.partOfSpeech),example:l(e?.example),contextMeaning:l(e?.contextMeaning),sourceSentence:l(e?.sourceSentence),lastReviewAt:e?.lastReviewAt||null,intervalHours:Number(e?.intervalHours||0)||void 0,nextReviewAt:e?.nextReviewAt||null}}function A(e,n){if(typeof localStorage>"u")return n;try{const t=localStorage.getItem(e);return t?JSON.parse(t):n}catch{return n}}function C(e,n){if(typeof localStorage>"u")return!1;try{return localStorage.setItem(e,JSON.stringify(n)),!0}catch{return!1}}function M(e){return[...e].sort((n,t)=>{const s=Date.parse(n.lastSeenAt||0)||0,r=Date.parse(t.lastSeenAt||0)||0;return s!==r?r-s:String(n.word||"").localeCompare(String(t.word||""))})}function _(){if(typeof localStorage>"u")return[];const e=[];for(let n=0;n<localStorage.length;n+=1){const t=localStorage.key(n);if(!t||!t.startsWith(g))continue;const s=t.slice(g.length),r=A(t,[]);if(Array.isArray(r))for(const o of r){const a=S(o);a.word&&e.push({...a,__episodeId:s})}}return e}function p(e,n,t={}){const s=f(e?.word);if(!s)return;const r=new Date().toISOString(),o=t.touchSeenAt!==!1,a=String(n||v||"").trim(),c=Array.isArray(d.value)?[...d.value]:[],w=c.findIndex(i=>f(i.word)===s);if(w===-1)c.push({word:e.word,definition:e.definition||"",example:e.example||"",sentence:e.sentence||"",contextMeaning:e.contextMeaning||"",sourceSentence:e.sourceSentence||e.sentence||"",adds:t.incrementAdds?1:0,reviewCount:t.reviewGrade?1:0,correctCount:t.reviewGrade&&t.reviewGrade!=="again"?1:0,lastGrade:t.reviewGrade||"",firstSeenAt:r,lastSeenAt:r,lastReviewedAt:t.reviewGrade?r:null,intervalHours:Number(e.intervalHours||0)||null,nextReviewAt:e.nextReviewAt||null,episodes:a?[a]:[],lastEpisodeId:a||""});else{const i=c[w],m=new Set(Array.isArray(i.episodes)?i.episodes:[]);a&&m.add(a),c[w]={...i,word:i.word||e.word,definition:e.definition||i.definition||"",example:e.example||i.example||"",sentence:e.sentence||i.sentence||"",contextMeaning:e.contextMeaning||i.contextMeaning||"",sourceSentence:e.sourceSentence||e.sentence||i.sourceSentence||i.sentence||"",adds:Number(i.adds||0)+(t.incrementAdds?1:0),reviewCount:Number(i.reviewCount||0)+(t.reviewGrade?1:0),correctCount:Number(i.correctCount||0)+(t.reviewGrade&&t.reviewGrade!=="again"?1:0),lastGrade:t.reviewGrade||i.lastGrade||"",lastSeenAt:o?r:i.lastSeenAt||r,lastReviewedAt:t.reviewGrade?r:i.lastReviewedAt||null,intervalHours:Number(e.intervalHours||0)||i.intervalHours||null,nextReviewAt:e.nextReviewAt||i.nextReviewAt||null,episodes:[...m],lastEpisodeId:a||i.lastEpisodeId||""}}d.value=M(c),C(y,d.value)}function L(){const e=A(y,null);d.value=Array.isArray(e)?M(e):[];const n=_(),t=d.value.length===0;for(const s of n)p(s,s.__episodeId,{incrementAdds:t,touchSeenAt:!1});return d.value}function W(e){v=String(e||"").trim(),L();const n=A(g+v,[]);u.value=Array.isArray(n)?n.map(t=>S(t)).filter(t=>t.word):[]}function J(e,n={}){const t=String(n?.episodeId||v||"").trim();if(!t||((!v||v!==t)&&W(t),u.value.length>=G))return!1;const s=S(e);return!s.word||u.value.some(r=>f(r.word)===f(s.word))?!1:(u.value=[...u.value,s],x(),p(s,t,{incrementAdds:!0}),!0)}function K(e){const n=f(e);u.value=u.value.filter(t=>f(t.word)!==n),x()}function X(e){const n=f(e);return u.value.some(t=>f(t.word)===n)}function Y(e,n){const t=f(e),s=u.value.findIndex(i=>f(i.word)===t);if(s===-1)return;const r=u.value[s],o=new Date().toISOString(),a=N(r.intervalHours||8,n),c=E(o,r.intervalHours||8,n),w={...r,lastReviewAt:o,intervalHours:a,nextReviewAt:c};u.value=[...u.value.slice(0,s),w,...u.value.slice(s+1)],x(),p(w,v,{reviewGrade:n})}function x(){v&&C(g+v,u.value)}function V(){const e=Array.isArray(d.value)?d.value:[],n=e.length,t=e.filter(r=>Number(r.reviewCount||0)>0).length,s=e.filter(r=>Number(r.correctCount||0)>=3).length;return{total:n,reviewed:t,mastered:s,learning:Math.max(0,n-s)}}function H(e){if(Number(e?.correctCount||0)>=3)return"mastered";const t=e?.nextReviewAt?Date.parse(e.nextReviewAt):NaN;return Number.isFinite(t)&&t<=Date.now()?"due":"learning"}function T(e){return l(e?.contextMeaning)||l(e?.definition)||"Meaning not saved"}function k(e,n=14){const t=Date.parse(e?.lastSeenAt||"");return Number.isFinite(t)?Date.now()-t<=n*24*60*60*1e3:!1}function D(e,n){const t=Date.parse(e.lastSeenAt||"")||0,s=Date.parse(n.lastSeenAt||"")||0;return t!==s?s-t:String(e.word||"").localeCompare(String(n.word||""))}function F(e={}){const n=String(e?.filter||"all").toLowerCase(),t=l(e?.search||"").toLowerCase(),s=String(e?.sort||"last_seen").toLowerCase();let r=Array.isArray(d.value)?[...d.value]:[];if(r=r.map(o=>{const a=H(o);return{...o,status:a,simpleMeaning:T(o),episodeCount:Array.isArray(o?.episodes)?o.episodes.length:o?.lastEpisodeId?1:0}}),t&&(r=r.filter(o=>l(o.word).toLowerCase().includes(t))),n==="due"||n==="learning"||n==="mastered"?r=r.filter(o=>o.status===n):n==="recent"&&(r=r.filter(o=>k(o,14))),s==="alphabetical")r.sort((o,a)=>String(o.word||"").localeCompare(String(a.word||"")));else if(s==="due_soon"){const o={due:0,learning:1,mastered:2};r.sort((a,c)=>{const w=(o[a.status]??3)-(o[c.status]??3);if(w!==0)return w;const i=Date.parse(a.nextReviewAt||""),m=Date.parse(c.nextReviewAt||""),h=Number.isFinite(i)?i:Number.MAX_SAFE_INTEGER,R=Number.isFinite(m)?m:Number.MAX_SAFE_INTEGER;return h!==R?h-R:D(a,c)})}else r.sort(D);return r}function j(e=5){const n=Math.max(0,Number(e||5));return F({filter:"all",sort:"last_seen"}).slice(0,n)}export{V as a,j as b,Y as c,u as d,X as e,J as f,F as g,z as i,W as l,K as r};
